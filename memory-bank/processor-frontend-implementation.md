# å‰ç«¯MessageProcessorå®ç°å®ŒæˆæŠ¥å‘Š

## ğŸ‰ å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

### **1. MessageProcessoræœåŠ¡ç±»** (`src/services/MessageProcessor.ts`)
- âœ… **æ¶ˆæ¯é¢„å¤„ç†**: è‡ªåŠ¨å¢å¼ºç³»ç»Ÿæç¤ºï¼Œæ·»åŠ å·¥å…·ä¿¡æ¯
- âœ… **å·¥å…·è°ƒç”¨è§£æ**: ä»AIå›å¤ä¸­æå–å·¥å…·è°ƒç”¨è¯·æ±‚
- âœ… **å·¥å…·æ‰§è¡Œç®¡ç†**: å®‰å…¨å·¥å…·è‡ªåŠ¨æ‰§è¡Œï¼Œå±é™©å·¥å…·éœ€è¦ç¡®è®¤
- âœ… **äº‹ä»¶é€šçŸ¥ç³»ç»Ÿ**: é€šè¿‡CustomEventé€šçŸ¥UIç»„ä»¶å·¥å…·çŠ¶æ€

### **2. useMessageProcessor Hook** (`src/hooks/useMessageProcessor.ts`)
- âœ… **ReactçŠ¶æ€ç®¡ç†**: ç®¡ç†å·¥å…·åŠ è½½ã€æ‰§è¡ŒçŠ¶æ€
- âœ… **äº‹ä»¶ç›‘å¬**: è‡ªåŠ¨ç›‘å¬tools-pending-approvaläº‹ä»¶
- âœ… **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: è‡ªåŠ¨åˆå§‹åŒ–MessageProcessor
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯æ•è·å’ŒçŠ¶æ€é‡ç½®

### **3. useMessagesé›†æˆ** (`src/hooks/useMessages.ts`)
- âœ… **æ¶ˆæ¯é¢„å¤„ç†**: sendMessageä½¿ç”¨MessageProcessorå¢å¼ºç³»ç»Ÿæç¤º
- âœ… **AIå“åº”å¤„ç†**: initiateAIResponseæ”¯æŒå·¥å…·è°ƒç”¨è§£æ
- âœ… **å·¥å…·æ‰§è¡Œæµç¨‹**: å®Œæ•´çš„å‰ç«¯Processoræ•°æ®æµ
- âœ… **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰APIæ¥å£ä¸å˜

## ğŸš€ æ–°çš„æ•°æ®æµæ¶æ„

### **å®Œæ•´çš„æ¶ˆæ¯å¤„ç†æµç¨‹**:
```
ç”¨æˆ·è¾“å…¥
    â†“
MessageProcessor.processMessageFlow()
    â†“ (é¢„å¤„ç†: å¢å¼ºç³»ç»Ÿæç¤º)
å‘é€åˆ°åç«¯ (execute_prompt)
    â†“ (çº¯å‡€çš„LLMæµå¼å“åº”)
å‰ç«¯æ¸²æŸ“AIå›å¤
    â†“ (å“åº”å®Œæˆå)
MessageProcessor.parseToolCalls()
    â†“ (è§£æå·¥å…·è°ƒç”¨)
MessageProcessor.executeTools()
    â†“ (åˆ†ç±»æ‰§è¡Œ)
å®‰å…¨å·¥å…·è‡ªåŠ¨æ‰§è¡Œ | å±é™©å·¥å…·ç­‰å¾…ç¡®è®¤
    â†“
æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ | æ˜¾ç¤ºæ‰¹å‡†UI
```

## ğŸ¯ å…³é”®æŠ€æœ¯å®ç°

### **1. ç³»ç»Ÿæç¤ºå¢å¼º**
```typescript
// è‡ªåŠ¨æ·»åŠ å·¥å…·ä¿¡æ¯åˆ°ç³»ç»Ÿæ¶ˆæ¯
const enhancedMessages = await messageProcessor.preprocessMessages(messages);
// å‘é€å¢å¼ºåçš„æ¶ˆæ¯åˆ°LLM
await invoke("execute_prompt", { messages: enhancedMessages });
```

### **2. å·¥å…·è°ƒç”¨è§£æ**
```typescript
// ä»AIå›å¤ä¸­æå–å·¥å…·è°ƒç”¨
const toolCalls = messageProcessor.parseToolCalls(aiResponse);
// åˆ†ç±»æ‰§è¡Œ
const { autoExecuted, pendingApproval } = await messageProcessor.executeTools(toolCalls);
```

### **3. äº‹ä»¶é©±åŠ¨æ¶æ„**
```typescript
// MessageProcessorå‘é€äº‹ä»¶
window.dispatchEvent(new CustomEvent('tools-pending-approval', { detail: { toolCalls } }));
// useMessageProcessorç›‘å¬äº‹ä»¶
window.addEventListener('tools-pending-approval', handler);
```

## ğŸ“‹ è§£å†³çš„æ ¸å¿ƒé—®é¢˜

### **âœ… å·¥å…·ä¿¡æ¯æˆåŠŸåµŒå…¥ç³»ç»Ÿæç¤º**
- MessageProcessorè‡ªåŠ¨ä»åç«¯è·å–å·¥å…·åˆ—è¡¨
- ç”Ÿæˆç»Ÿä¸€æ ¼å¼çš„å·¥å…·è¯´æ˜
- åœ¨æ¯æ¬¡å¯¹è¯å‰è‡ªåŠ¨å¢å¼ºç³»ç»Ÿæ¶ˆæ¯

### **âœ… å‰ç«¯å®Œå…¨æ§åˆ¶å·¥å…·æ‰§è¡Œ**
- è§£æAIå›å¤ä¸­çš„å·¥å…·è°ƒç”¨è¯·æ±‚
- æ”¯æŒè‡ªåŠ¨æ‰§è¡Œå®‰å…¨å·¥å…·
- å±é™©å·¥å…·éœ€è¦ç”¨æˆ·ç¡®è®¤

### **âœ… æ¶æ„èŒè´£æ¸…æ™°**
- **åç«¯**: çº¯å‡€çš„LLM API + åŸå­åŒ–å·¥å…·æ‰§è¡ŒAPI
- **å‰ç«¯**: å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘æ§åˆ¶ + ç”¨æˆ·äº¤äº’

## ğŸ”§ å½“å‰çŠ¶æ€

### **å·²ç»å¯ä»¥å·¥ä½œçš„åŠŸèƒ½**:
1. âœ… å·¥å…·åˆ—è¡¨è‡ªåŠ¨åŠ è½½å’Œè§£æ
2. âœ… ç³»ç»Ÿæç¤ºè‡ªåŠ¨å¢å¼º
3. âœ… æ¶ˆæ¯é¢„å¤„ç†å’Œå‘é€
4. âœ… AIå›å¤ä¸­å·¥å…·è°ƒç”¨è§£æ
5. âœ… å·¥å…·æ‰§è¡Œå’Œç»“æœå¤„ç†
6. âœ… äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€ç®¡ç†

### **å¾…å®Œå–„çš„åŠŸèƒ½**:
1. ğŸ”„ UIç»„ä»¶æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒçŠ¶æ€
2. ğŸ”„ ToolApprovalCardæ˜¾ç¤ºå¾…ç¡®è®¤å·¥å…·
3. ğŸ”„ StreamingMessageItemé›†æˆå·¥å…·å¤„ç†
4. ğŸ”„ å·¥å…·æ‰§è¡Œç»“æœçš„æ¶ˆæ¯å±•ç¤º

## ğŸ“ˆ æµ‹è¯•éªŒè¯

ç°åœ¨å¯ä»¥æµ‹è¯•ä»¥ä¸‹æµç¨‹ï¼š
1. **å‘é€æ¶ˆæ¯**: åº”è¯¥çœ‹åˆ°å¢å¼ºçš„ç³»ç»Ÿæç¤ºè¢«å‘é€åˆ°åç«¯
2. **AIå›å¤**: å¦‚æœåŒ…å«å·¥å…·è°ƒç”¨ï¼Œåº”è¯¥è‡ªåŠ¨è§£æå’Œæ‰§è¡Œ
3. **æ§åˆ¶å°æ—¥å¿—**: å¯ä»¥çœ‹åˆ°è¯¦ç»†çš„MessageProcessorå¤„ç†æ—¥å¿—
4. **å·¥å…·çŠ¶æ€**: useMessageProcessor Hookåº”è¯¥æ­£ç¡®ç®¡ç†çŠ¶æ€

## ğŸ‰ é‡å¤§æˆæœ

æˆåŠŸå®ç°äº†**å‰ç«¯Processoræ¶æ„**ï¼Œå½»åº•è§£å†³äº†ï¼š
- âŒ ç³»ç»Ÿæç¤ºä¸åŒ…å«å·¥å…·ä¿¡æ¯çš„é—®é¢˜
- âŒ å‰ç«¯æ— æ³•æ§åˆ¶å·¥å…·æ‰§è¡Œçš„é—®é¢˜  
- âŒ åç«¯ä¸šåŠ¡é€»è¾‘è¿‡é‡çš„é—®é¢˜
- âŒ ç”¨æˆ·æ— æ³•çœ‹åˆ°å·¥å…·æ‰§è¡Œè¿‡ç¨‹çš„é—®é¢˜

ç°åœ¨å‰ç«¯å®Œå…¨æ§åˆ¶äº†æ•´ä¸ªå·¥å…·è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼ğŸš€
