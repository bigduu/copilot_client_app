# Context Manager & Session Manager æ¶æ„é‡æ„ - å®Œæ•´ææ¡ˆ

## âœ… ææ¡ˆçŠ¶æ€

**Status**: Ready for Approval  
**Validation**: âœ… OpenSpec Strict Mode Passed  
**Created**: 2025-11-05  
**Total Tasks**: 167  
**Estimated Duration**: 12-14 weeks  

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1ï¸âƒ£ Context Manager ç®¡ç†ä¸€åˆ‡
- âœ… æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ
- âœ… çŠ¶æ€æœºï¼ˆFSMï¼‰
- âœ… æµå¼è¾“å‡ºå¤„ç†
- âœ… å·¥å…·è°ƒç”¨å’ŒMCPé›†æˆ
- âœ… Branchç®¡ç†å’Œåˆå¹¶
- âœ… ä¸Šä¸‹æ–‡ä¼˜åŒ–
- âœ… å­˜å‚¨åè°ƒ

### 2ï¸âƒ£ çŠ¶æ€é©±åŠ¨æ¶æ„
- âœ… æ¸…æ™°çš„FSMçŠ¶æ€è½¬æ¢
- âœ… ContextUpdateäº‹ä»¶æµ
- âœ… å‰ç«¯UIåŸºäºçŠ¶æ€æ¸²æŸ“
- âœ… å¯æµ‹è¯•ï¼ˆä¸ä¾èµ–çœŸå®LLMï¼‰

### 3ï¸âƒ£ åç«¯å®Œå…¨ä¸»å¯¼
- âœ… Session Manageråœ¨åç«¯ç»Ÿä¸€ç®¡ç†
- âœ… ä¼šè¯çŠ¶æ€é€šè¿‡RESTful API CRUD
- âœ… å·¥å…·ç³»ç»Ÿå®Œå…¨åç«¯æ§åˆ¶
- âœ… å¤šå®¢æˆ·ç«¯è‡ªåŠ¨åŒæ­¥

### 4ï¸âƒ£ å‰ç«¯åªè´Ÿè´£å±•ç¤º
- âœ… ç»´æŠ¤å½“å‰å¯¹è¯çš„Contextå‰¯æœ¬ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- âœ… é€šè¿‡ContextUpdateæµå¼åŒæ­¥çŠ¶æ€
- âœ… çº¯UIçŠ¶æ€å¯ä»¥æœ¬åœ°ç®¡ç†
- âœ… æ‰€æœ‰ä¸šåŠ¡æ“ä½œé€šè¿‡API

---

## ğŸ“‹ å…³é”®åŠŸèƒ½æ¸…å•

### Context Manager æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | Requirements | Scenarios |
|------|------|--------------|-----------|
| **é€»è¾‘é›†ä¸­åŒ–** | web_serviceé€»è¾‘è¿ç§»åˆ°context_manager | 1 | 3 |
| **æ¶ˆæ¯ç±»å‹ç³»ç»Ÿ** | ä¸°å¯Œçš„å†…éƒ¨æ¶ˆæ¯ç±»å‹ï¼ˆText, Image, FileRef, Tool, MCP, etc.ï¼‰ | 1 | 5 |
| **æ¶ˆæ¯å¤„ç†Pipeline** | å¯ç»„åˆçš„Processorï¼ˆValidation, FileRef, Tool, etc.ï¼‰ | 1 | 4 |
| **å·¥å…·è‡ªåŠ¨å¾ªç¯** | å¯é…ç½®çš„è‡ªåŠ¨å·¥å…·æ‰§è¡Œï¼ˆAuto/Manual/WhiteListï¼‰ | 1 | 5 |
| **æµå¼Contextæ›´æ–°** | ContextUpdateäº‹ä»¶æµï¼ŒåŒ…å«å®Œæ•´çŠ¶æ€ | 1 | 5 |
| **ä¸Šä¸‹æ–‡ä¼˜åŒ–** | æ™ºèƒ½å‹ç¼©å’Œæ€»ç»“ï¼Œæ”¯æŒé•¿å¯¹è¯ | 1 | 4 |
| **åŠ¨æ€System Prompt** | åŸºäºæ¨¡å¼ã€è§’è‰²ã€å·¥å…·åŠ¨æ€ç”Ÿæˆ | 1 | 4 |
| **ç»Ÿä¸€å·¥å…·ç³»ç»Ÿ** | å†…ç½®å·¥å…· + MCPé›†æˆï¼Œç»Ÿä¸€æ¥å£ | 1 | 7 |
| **Codebaseå·¥å…·** | ä»£ç æœç´¢ã€ç¬¦å·æŸ¥æ‰¾ã€é¡¹ç›®æ¦‚è§ˆ | 1 | 5 |
| **Branchåˆå¹¶** | ä¸‰ç§ç­–ç•¥ï¼ˆAppend, CherryPick, Rebaseï¼‰ | 1 | 5 |
| **æµ‹è¯•æ”¯æŒ** | Mock LLMï¼ŒçŠ¶æ€æœºæµ‹è¯• | 1 | 4 |

### Session Manager æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | Requirements | Scenarios |
|------|------|--------------|-----------|
| **åç«¯ä¼šè¯ç®¡ç†** | ç»Ÿä¸€ç®¡ç†UserSessionçŠ¶æ€ | 1 | 3 |
| **æ´»åŠ¨å¯¹è¯ç®¡ç†** | è¿½è¸ªå½“å‰æ´»åŠ¨çš„å¯¹è¯ | 1 | 3 |
| **å¤šæ ‡ç­¾é¡µç®¡ç†** | ç®¡ç†æ‰“å¼€çš„å¯¹è¯åˆ—è¡¨ | 1 | 4 |
| **UIçŠ¶æ€æŒä¹…åŒ–** | ä¿å­˜ä¾§è¾¹æ ã€å±•å¼€çŠ¶æ€ç­‰ | 1 | 3 |
| **ç”¨æˆ·åå¥½ç®¡ç†** | ä¸»é¢˜ã€å­—ä½“ã€å·¥å…·ç­–ç•¥ç­‰ | 1 | 3 |
| **åç«¯å­˜å‚¨** | æ–‡ä»¶ç³»ç»ŸæŒä¹…åŒ–ï¼Œå†…å­˜ç¼“å­˜ | 1 | 4 |
| **ç”Ÿå‘½å‘¨æœŸç®¡ç†** | åˆå§‹åŒ–ã€æ›´æ–°ã€åŒæ­¥ã€æ¸…ç† | 1 | 4 |
| **Contextç¼“å­˜** | LRUç¼“å­˜ï¼ŒRwLockå¹¶å‘æ§åˆ¶ | 1 | 2 |

### æ¶ˆæ¯ç±»å‹ç³»ç»Ÿ

| æ¶ˆæ¯ç±»å‹ | ç”¨é€” | Scenarios |
|---------|------|-----------|
| **Text** | æ™®é€šæ–‡æœ¬æ¶ˆæ¯ | 1 |
| **Image** | å›¾ç‰‡ï¼ˆVision/OCRåŒæ¨¡å¼ï¼‰ | 6 |
| **FileReference** | æ–‡ä»¶å¼•ç”¨å’Œå†…å®¹è§£æ | 4 |
| **ToolRequest** | å·¥å…·è°ƒç”¨è¯·æ±‚ | 4 |
| **ToolResult** | å·¥å…·æ‰§è¡Œç»“æœ | 3 |
| **MCPResource** | MCPèµ„æºæ³¨å…¥ | 4 |
| **SystemControl** | ç³»ç»Ÿæ§åˆ¶æ¶ˆæ¯ | 2 |
| **Processing** | å¤„ç†ä¸­æ¶ˆæ¯ | - |

### å­˜å‚¨åˆ†ç¦»æ¶æ„

| ç»„ä»¶ | å­˜å‚¨ä½ç½® | æ›´æ–°é¢‘ç‡ |
|------|---------|---------|
| **å…ƒæ•°æ®** | `metadata.json` | ä½ï¼ˆé…ç½®å˜æ›´ï¼‰ |
| **Branchç»“æ„** | `metadata.json` | ä½ï¼ˆåˆ†æ”¯æ“ä½œï¼‰ |
| **å•ä¸ªæ¶ˆæ¯** | `messages/branch-{name}/{msg_id}.json` | é«˜ï¼ˆæ¯æ¡æ¶ˆæ¯ï¼‰ |
| **æ¶ˆæ¯ç´¢å¼•** | `index.json` | ä¸­ï¼ˆæ¶ˆæ¯å¢åˆ ï¼‰ |
| **ä¼šè¯çŠ¶æ€** | `user_sessions/default_session.json` | ä¸­ï¼ˆUIæ“ä½œï¼‰ |

---

## ğŸ—ï¸ æ¶æ„å›¾ç¤º

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (æ— çŠ¶æ€)                        â”‚
â”‚  - ç»´æŠ¤å½“å‰Contextå‰¯æœ¬ï¼ˆæ€§èƒ½ï¼‰                                 â”‚
â”‚  - æ¥æ”¶ContextUpdateæµå¼åŒæ­¥                                  â”‚
â”‚  - çº¯UIçŠ¶æ€æœ¬åœ°ç®¡ç†                                           â”‚
â”‚  - æ‰€æœ‰ä¸šåŠ¡æ“ä½œé€šè¿‡API                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ RESTful API / SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend (ä¸»å¯¼æ§åˆ¶)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Context Manager (æ ¸å¿ƒæ§åˆ¶å™¨)                â”‚   â”‚
â”‚  â”‚  - æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ                                       â”‚   â”‚
â”‚  â”‚  - FSMçŠ¶æ€æœº                                         â”‚   â”‚
â”‚  â”‚  - MessagePipelineå¤„ç†                               â”‚   â”‚
â”‚  â”‚  - æµå¼è¾“å‡º                                          â”‚   â”‚
â”‚  â”‚  - å·¥å…·è°ƒç”¨å¾ªç¯                                       â”‚   â”‚
â”‚  â”‚  - ä¸Šä¸‹æ–‡ä¼˜åŒ–                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Session Manager (ä¼šè¯ç®¡ç†)                  â”‚   â”‚
â”‚  â”‚  - UserSessionç®¡ç†                                   â”‚   â”‚
â”‚  â”‚  - ChatContextç¼“å­˜                                   â”‚   â”‚
â”‚  â”‚  - API endpoints                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Tool Registry (å·¥å…·ç³»ç»Ÿ)                    â”‚   â”‚
â”‚  â”‚  - å†…ç½®å·¥å…·                                          â”‚   â”‚
â”‚  â”‚  - MCPé›†æˆ                                           â”‚   â”‚
â”‚  â”‚  - Codebaseå·¥å…·                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
                   LLM / MCP Servers
```

### æ•°æ®æµå‘

```
ç”¨æˆ·æ“ä½œ â†’ Frontend UI â†’ API Request â†’ Backend
                                          â†“
                                    Context Manager
                                    - çŠ¶æ€è½¬æ¢
                                    - Pipelineå¤„ç†
                                    - å·¥å…·æ‰§è¡Œ
                                          â†“
                                    ContextUpdate Stream
                                          â†“
                                    Frontend (æ›´æ–°æœ¬åœ°å‰¯æœ¬)
                                          â†“
                                    UI Rendering (çŠ¶æ€é©±åŠ¨)
```

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡è¡¥å……

### ç»†ç²’åº¦çŠ¶æ€æœº (25+ è¯¦ç»†çŠ¶æ€)

**åŸåˆ™**: æ¯ä¸ªæ“ä½œéƒ½æœ‰æ˜ç¡®çš„çŠ¶æ€ï¼ŒçŠ¶æ€æœ¬èº«å®Œå…¨è‡ªè§£é‡Šï¼Œä¸éœ€è¦é¢å¤–å­—æ®µ

**çŠ¶æ€å®Œæ•´åˆ—è¡¨**:
```rust
pub enum ContextState {
    // ç©ºé—²å’Œå‡†å¤‡
    Idle, Initializing, Paused, Cancelling,
    
    // æ¶ˆæ¯å¤„ç†é˜¶æ®µï¼ˆ5ä¸ªï¼‰
    ProcessingUserMessage, ResolvingFileReferences,
    EnhancingSystemPrompt, OptimizingContext, PreparingLLMRequest,
    
    // LLMäº¤äº’é˜¶æ®µï¼ˆ5ä¸ªï¼‰
    ConnectingToLLM, AwaitingLLMFirstChunk,
    StreamingLLMResponse { chunks_received, chars_accumulated },
    ProcessingLLMResponse,
    
    // å·¥å…·è°ƒç”¨é˜¶æ®µï¼ˆ6ä¸ªï¼‰
    ParsingToolCalls,
    AwaitingToolApproval { pending_requests, tool_names },
    ExecutingTool { tool_name, attempt },
    CollectingToolResults, ProcessingToolResults,
    ToolAutoLoop { depth, tools_executed },
    
    // Branchæ“ä½œï¼ˆ2ä¸ªï¼‰
    SwitchingBranch { from, to },
    MergingBranches { source, target, strategy },
    
    // å­˜å‚¨æ“ä½œï¼ˆ3ä¸ªï¼‰
    SavingContext,
    SavingMessage { message_id },
    LoadingMessages { loaded, total },
    
    // ä¼˜åŒ–é˜¶æ®µï¼ˆ2ä¸ªï¼‰
    CompressingMessages { messages_to_compress },
    GeneratingSummary,
    
    // é”™è¯¯å¤„ç†ï¼ˆ3ä¸ªï¼‰
    TransientError { error_type, retry_count, max_retries },
    WaitingForRecovery,
    Failed { error_message, failed_at },
}
```

**å‰ç«¯UIå®Œå…¨çŠ¶æ€é©±åŠ¨**:
```typescript
// æ¯ä¸ªçŠ¶æ€éƒ½æœ‰å¯¹åº”çš„UI
ExecutingTool { tool_name: "read_file", attempt: 2 }
  â†“
<Progress>æ­£åœ¨æ‰§è¡Œå·¥å…· 2/3: read_file</Progress>

ToolAutoLoop { depth: 2, tools_executed: 5 }
  â†“
<AutoLoopIndicator>è‡ªåŠ¨å¤„ç†ä¸­ï¼ˆç¬¬2è½®ï¼Œå·²æ‰§è¡Œ5ä¸ªå·¥å…·ï¼‰</AutoLoopIndicator>
```

### æ¨¡å—åŒ–æ–‡ä»¶ç»„ç»‡

**ç›®æ ‡**: æ¯ä¸ªæ–‡ä»¶ < 300è¡Œï¼ŒåŠŸèƒ½åˆ†ç»„æ¸…æ™°

**æ¨¡å—åˆ’åˆ†**:
```
context_manager/src/
â”œâ”€â”€ context/        (4ä¸ªæ–‡ä»¶, ~800è¡Œ)
â”œâ”€â”€ state/          (4ä¸ªæ–‡ä»¶, ~900è¡Œ)
â”œâ”€â”€ messages/       (9ä¸ªæ–‡ä»¶, ~1800è¡Œ)
â”œâ”€â”€ pipeline/       (6ä¸ªæ–‡ä»¶, ~1400è¡Œ)
â”œâ”€â”€ tools/          (20ä¸ªæ–‡ä»¶, ~4500è¡Œ)
â”œâ”€â”€ optimization/   (6ä¸ªæ–‡ä»¶, ~1400è¡Œ)
â”œâ”€â”€ storage/        (7ä¸ªæ–‡ä»¶, ~1650è¡Œ)
â”œâ”€â”€ branch/         (4ä¸ªæ–‡ä»¶, ~1000è¡Œ)
â”œâ”€â”€ streaming/      (3ä¸ªæ–‡ä»¶, ~700è¡Œ)
â””â”€â”€ testing/        (4ä¸ªæ–‡ä»¶, ~850è¡Œ)

æ€»è®¡: ~60ä¸ªæ–‡ä»¶, å¹³å‡æ¯ä¸ªæ–‡ä»¶ ~220è¡Œ
```

**æµ‹è¯•è¦†ç›–**:
```
tests/
â”œâ”€â”€ å•å…ƒæµ‹è¯•ï¼ˆæ¯ä¸ªæ¨¡å—ä¸€ä¸ªæ–‡ä»¶ï¼‰
â”œâ”€â”€ integration/ï¼ˆ9ä¸ªå®Œæ•´åœºæ™¯ï¼‰
â””â”€â”€ benchmarks/ï¼ˆæ€§èƒ½æµ‹è¯•ï¼‰
```

## ğŸ“‹ è®¾è®¡å®Œæ•´æ€§ç¡®è®¤æ¸…å•

| è®¾è®¡åŸåˆ™ | å½“å‰è®¾è®¡ | çŠ¶æ€ |
|---------|---------|------|
| Context Managerç®¡ç†ä¸€åˆ‡ | âœ… æ¶ˆæ¯ã€çŠ¶æ€ã€å·¥å…·ã€æµå¼ã€ä¼˜åŒ– | âœ… å®Œå…¨ç¬¦åˆ |
| çŠ¶æ€é©±åŠ¨æ§åˆ¶æµç¨‹ | âœ… 25+ç»†ç²’åº¦çŠ¶æ€ + ContextUpdate | âœ… å®Œå…¨ç¬¦åˆ |
| åç«¯ç®¡ç†ä¼šè¯çŠ¶æ€ | âœ… Session Manageråœ¨åç«¯ | âœ… å®Œå…¨ç¬¦åˆ |
| å‰ç«¯åªå±•ç¤ºä¸ç®¡ç† | âœ… é€šè¿‡APIæ“ä½œ | âœ… å®Œå…¨ç¬¦åˆ |
| å·¥å…·å¯¹ç”¨æˆ·é€æ˜ | âœ… ä¸å±•ç¤ºç»™ç”¨æˆ·ï¼ŒAIè‡ªä¸»å†³ç­– | âœ… å®Œå…¨ç¬¦åˆ |
| ä¸»åŠ¨æ³¨å…¥ä¸Šä¸‹æ–‡ | âœ… workspaceæ¦‚è§ˆç­‰ | âœ… å®Œå…¨ç¬¦åˆ |
| æ¨¡å—åŒ–æ–‡ä»¶ç»„ç»‡ | âœ… 60ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª<300è¡Œ | âœ… å®Œå…¨ç¬¦åˆ |
| è¯¦ç»†çŠ¶æ€è®¾è®¡ | âœ… 25+çŠ¶æ€ï¼Œå®Œå…¨è‡ªè§£é‡Š | âœ… å®Œå…¨ç¬¦åˆ |
| å…¨é¢æµ‹è¯•è¦†ç›– | âœ… å•å…ƒ+é›†æˆ+è¾¹ç•Œ+æ€§èƒ½ | âœ… å®Œå…¨ç¬¦åˆ |

## ğŸ“Š è®¾è®¡å†³ç­–æ€»ç»“

| # | å†³ç­– | æ ¸å¿ƒå†…å®¹ |
|---|------|---------|
| -1 | Fine-Grained State Machine | 25+è¯¦ç»†çŠ¶æ€ï¼Œå®Œå…¨è‡ªè§£é‡Š |
| -0.5 | Modular File Organization | 60ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª<300è¡Œ |
| 0 | Logic Migration | web_serviceé€»è¾‘è¿ç§»åˆ°context_manager |
| 1 | Message Type System | å¼ºç±»å‹æšä¸¾ï¼Œä¸°å¯Œçš„å†…éƒ¨ç±»å‹ |
| 1.5 | Internal vs LLM Format | å†…éƒ¨è¯¦ç»†è®°å½•ï¼Œå‘LLMæ—¶è½¬æ¢ |
| 2 | Message Pipeline | å¯ç»„åˆçš„Processoræ¶æ„ |
| 3 | Storage Separation | å¤šæ–‡ä»¶å­˜å‚¨ï¼Œå…ƒæ•°æ®ä¸æ¶ˆæ¯åˆ†ç¦» |
| 4 | Tool Auto-Loop | å¯é…ç½®å®¡æ‰¹ç­–ç•¥ï¼Œè‡ªåŠ¨æ‰§è¡Œ |
| 4.5 | Streaming Context Updates | å®Œæ•´ContextUpdateè€Œéçº¯æ–‡æœ¬ |
| 4.6 | Context Optimization | æ™ºèƒ½å‹ç¼©å’Œæ€»ç»“ |
| 5 | Backend Session Manager | åç«¯ç»Ÿä¸€ç®¡ç†ï¼Œå‰ç«¯APIæ“ä½œ |
| 6 | Unified Tool System | å†…ç½® + MCPç»Ÿä¸€æ¥å£ |
| 6.1 | Tools Invisible to Users | å·¥å…·å¯¹ç”¨æˆ·é€æ˜ï¼ŒAIè‡ªä¸»å†³ç­– |
| 6.2 | Proactive Context Injection | ä¸»åŠ¨æ³¨å…¥workspaceä¿¡æ¯ |
| 6.3 | Explicit Tool Registration | æ˜¾å¼æ³¨å†Œï¼Œæ¸…æ™°ä¾èµ– |
| 7 | Branch Merging | ä¸‰ç§åˆå¹¶ç­–ç•¥ |
| 8 | Testing Without LLM | Mock LLMæ”¯æŒ |
| 9 | Compression Trigger | è‡ªåŠ¨+æ‰‹åŠ¨åŒæ¨¡å¼ |
| 10 | Frontend Context Management | ç»´æŠ¤å‰¯æœ¬ï¼Œæµå¼åŒæ­¥ |

---

## ğŸ¯ æ ¸å¿ƒç†å¿µéªŒè¯

### âœ… Context Managerç®¡ç†ä¸€åˆ‡
- [x] æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºã€éªŒè¯ã€å¢å¼ºã€æ‰§è¡Œã€å­˜å‚¨ï¼‰
- [x] çŠ¶æ€æœºç®¡ç†ï¼ˆä¸åœ¨web_serviceï¼‰
- [x] æµå¼è¾“å‡ºå¤„ç†ï¼ˆSSEè§£æã€chunkç´¯ç§¯ï¼‰
- [x] å·¥å…·è°ƒç”¨å¾ªç¯ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
- [x] MCPé›†æˆï¼ˆç»Ÿä¸€æ¥å£ï¼‰
- [x] Branchç®¡ç†ï¼ˆåˆ›å»ºã€åˆ‡æ¢ã€åˆå¹¶ï¼‰
- [x] ä¸Šä¸‹æ–‡ä¼˜åŒ–ï¼ˆå‹ç¼©ã€æ€»ç»“ï¼‰
- [x] å­˜å‚¨åè°ƒï¼ˆåˆ†ç¦»å­˜å‚¨ï¼‰

### âœ… çŠ¶æ€é©±åŠ¨æ§åˆ¶æµç¨‹
- [x] FSMçŠ¶æ€æœºï¼ˆIdle â†’ Processing â†’ Streaming â†’ ToolLoop â†’ Idleï¼‰
- [x] ContextUpdateäº‹ä»¶æµï¼ˆçŠ¶æ€ã€æ¶ˆæ¯ã€å…ƒæ•°æ®ï¼‰
- [x] å‰ç«¯UIæ ¹æ®current_stateæ¸²æŸ“
- [x] æ‰€æœ‰æ“ä½œé€šè¿‡çŠ¶æ€è½¬æ¢

### âœ… åç«¯ä¸»å¯¼ä¸€åˆ‡
- [x] Session Manageråœ¨åç«¯ï¼ˆUserSession, UIState, Preferencesï¼‰
- [x] Context Manageråœ¨åç«¯ï¼ˆæ¶ˆæ¯ã€çŠ¶æ€ã€å·¥å…·ï¼‰
- [x] å·¥å…·ç³»ç»Ÿåœ¨åç«¯ï¼ˆToolRegistry, MCPï¼‰
- [x] å­˜å‚¨åœ¨åç«¯ï¼ˆå¤šæ–‡ä»¶ç»“æ„ï¼‰
- [x] å‰ç«¯é€šè¿‡API CRUD

### âœ… å‰ç«¯åªè´Ÿè´£å±•ç¤º
- [x] ç»´æŠ¤å½“å‰Contextå‰¯æœ¬ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- [x] é€šè¿‡ContextUpdateæµå¼åŒæ­¥
- [x] çº¯UIçŠ¶æ€å¯æœ¬åœ°ç®¡ç†ï¼ˆè¾“å…¥æ¡†ã€æ»šåŠ¨ç­‰ï¼‰
- [x] ä¸šåŠ¡æ“ä½œå…¨éƒ¨é€šè¿‡API
- [x] å·¥å…·å¯¹ç”¨æˆ·ä¸å¯è§

---

## ğŸ“¦ äº¤ä»˜ç‰©

### æ–‡æ¡£
- âœ… `proposal.md` - å®Œæ•´ææ¡ˆæ¦‚è¿°
- âœ… `design.md` - è¯¦ç»†æ¶æ„è®¾è®¡ï¼ˆ10ä¸ªå†³ç­–ï¼‰
- âœ… `tasks.md` - å®æ–½ä»»åŠ¡æ¸…å•ï¼ˆ167ä¸ªä»»åŠ¡ï¼‰
- âœ… `README.md` - æœ¬æ–‡æ¡£

### Spec Deltas
- âœ… `specs/context-manager/spec.md` - 11ä¸ªRequirements, 48ä¸ªScenarios
- âœ… `specs/session-manager/spec.md` - 8ä¸ªRequirements, 29ä¸ªScenarios
- âœ… `specs/message-types/spec.md` - 7ä¸ªRequirements, 34ä¸ªScenarios
- âœ… `specs/storage-separation/spec.md` - 6ä¸ªRequirements, 25ä¸ªScenarios

### ä»£ç ç¤ºä¾‹
- âœ… 10+ Rustä»£ç ç¤ºä¾‹
- âœ… 5+ TypeScriptå‰ç«¯ç¤ºä¾‹
- âœ… 2+ é…ç½®æ–‡ä»¶ç¤ºä¾‹
- âœ… å®Œæ•´çš„Mockæµ‹è¯•ç¤ºä¾‹

---

## ğŸš€ å®æ–½è·¯çº¿å›¾

### Phase 0: Logic Migration (Week 1-2)
å°†web_serviceä¸­çš„çŠ¶æ€æœºå’Œæµå¼å¤„ç†é€»è¾‘è¿ç§»åˆ°context_manager

### Phase 1: Message Type System (Week 2-3)
å®ç°å¼ºç±»å‹æ¶ˆæ¯æšä¸¾å’Œå‘åå…¼å®¹è½¬æ¢å±‚

### Phase 2: Message Pipeline (Week 3-4)
å®ç°å¯ç»„åˆçš„MessageProcessorå’ŒPipeline

### Phase 3: Context Manager Enhancement (Week 4-5)
å¢å¼ºFSMã€é›†æˆPipelineã€å®ç°åŠ¨æ€System Prompt

### Phase 4: Storage Separation (Week 5-7)
å®ç°å¤šæ–‡ä»¶å­˜å‚¨ã€æ•°æ®è¿ç§»å·¥å…·ã€æ€§èƒ½æµ‹è¯•

### Phase 4.5: Context Optimization (Week 7-8)
Tokenè®¡æ•°ã€æ™ºèƒ½ä¼˜åŒ–ã€å‹ç¼©æ€»ç»“

### Phase 5: Tool Auto-Loop (Week 8-9)
å®¡æ‰¹ç­–ç•¥ã€è‡ªåŠ¨å¾ªç¯ã€å®‰å…¨æœºåˆ¶

### Phase 6: Tool System Redesign (Week 9-10)
æ˜¾å¼æ³¨å†Œã€MCPé›†æˆã€Codebaseå·¥å…·

### Phase 7: Backend Session Manager (Week 10-11)
UserSessionç®¡ç†ã€RESTful APIã€çŠ¶æ€æŒä¹…åŒ–

### Phase 8: Frontend Integration (Week 11-12)
Contextå‰¯æœ¬ç®¡ç†ã€ContextUpdateå¤„ç†ã€UIçŠ¶æ€é©±åŠ¨

### Phase 9-10: Testing & Release (Week 12-14)
é›†æˆæµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€æ–‡æ¡£ã€Betaå‘å¸ƒ

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒç¤ºä¾‹

### å…¸å‹å¯¹è¯æµç¨‹

```
[ç”¨æˆ·è§†è§’]
ç”¨æˆ·: "å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™ä¸ªé¡¹ç›®çš„ä¸»è¦ç»“æ„"
  â†“
AI: "å¥½çš„ï¼Œè®©æˆ‘çœ‹çœ‹é¡¹ç›®ç»“æ„...
    
    è¿™æ˜¯ä¸€ä¸ªRust + TypeScriptæ··åˆé¡¹ç›®ï¼š
    
    åç«¯ï¼ˆRustï¼‰:
    - src/main.rs - ç¨‹åºå…¥å£
    - crates/context_manager - æ ¸å¿ƒå¯¹è¯ç®¡ç†
    - crates/web_service - WebæœåŠ¡å±‚
    
    å‰ç«¯ï¼ˆTypeScriptï¼‰:
    - src/App.tsx - å‰ç«¯å…¥å£
    - src/components/ - UIç»„ä»¶
    
    éœ€è¦æˆ‘è¯¦ç»†åˆ†æå“ªä¸ªéƒ¨åˆ†ï¼Ÿ"

[å†…éƒ¨æµç¨‹]
1. Context Manageræ”¶åˆ°æ¶ˆæ¯
2. æ£€æŸ¥System Promptä¸­é¢„æ³¨å…¥çš„workspace_overview
3. è°ƒç”¨codebase_searchè¡¥å……ç»†èŠ‚ï¼ˆè‡ªåŠ¨ï¼Œç”¨æˆ·ä¸çŸ¥é“ï¼‰
4. ç»„åˆä¿¡æ¯ï¼Œç”Ÿæˆè‡ªç„¶è¯­è¨€å›ç­”
5. é€šè¿‡ContextUpdateæµè¿”å›
```

### å·¥å…·è‡ªåŠ¨å¾ªç¯ç¤ºä¾‹

```
[ç”¨æˆ·è§†è§’]
ç”¨æˆ·: "å¸®æˆ‘æ‰¾å‡ºæ‰€æœ‰ä½¿ç”¨äº†ChatContextçš„åœ°æ–¹ï¼Œå¹¶æ€»ç»“ä¸€ä¸‹ç”¨æ³•"
  â†“
AI: "æ­£åœ¨åˆ†æä»£ç åº“..."
    ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼šcodebase_search â†’ æ‰¾åˆ°10å¤„å¼•ç”¨ â†’ find_definition â†’ read_file...ï¼‰
    "æˆ‘æ‰¾åˆ°äº†ChatContextåœ¨ä»¥ä¸‹10ä¸ªæ–‡ä»¶ä¸­è¢«ä½¿ç”¨..."

[å†…éƒ¨æµç¨‹]
1. å·¥å…·ç­–ç•¥ï¼šWhiteList(codebaseå·¥å…·è‡ªåŠ¨æ‰¹å‡†)
2. Loop 1: codebase_search("ChatContext")
3. Loop 2: find_references("ChatContext")  
4. Loop 3: read_file(æ¯ä¸ªå¼•ç”¨æ–‡ä»¶) - å¯èƒ½5æ¬¡å·¥å…·è°ƒç”¨
5. è‡ªåŠ¨å¾ªç¯ç›´åˆ°è·å¾—è¶³å¤Ÿä¿¡æ¯
6. è¿”å›ç»¼åˆåˆ†æ

ç”¨æˆ·ä½“éªŒï¼šä¸€æ¬¡æé—®ï¼ŒAIè‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤
```

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. ä¸°å¯Œçš„å†…éƒ¨ç±»å‹ vs ç®€åŒ–çš„LLMæ ¼å¼
```rust
// å†…éƒ¨ï¼šè¯¦ç»†è®°å½•æ‰€æœ‰ç»†èŠ‚
MessageType::FileReference {
    path, line_range, 
    resolved_content, resolved_at, resolution_error
}

// å‘ç»™LLMï¼šåªå‘é€resolvedå†…å®¹
OpenAIMessage {
    role: "user",
    content: resolved_content
}
```

### 2. ä¸»åŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥
```
System Promptè‡ªåŠ¨åŒ…å«ï¼š
- Workspaceæ ¹è·¯å¾„
- ç›®å½•ç»“æ„ï¼ˆ2-3å±‚ï¼‰
- ä¸»è¦è¯­è¨€
- æœ€è¿‘è®¿é—®çš„æ–‡ä»¶
- å¯ç”¨å·¥å…·èƒ½åŠ›

â†’ AIé¦–æ¬¡å›å¤å°±å¾ˆå‡†ç¡®
```

### 3. ç»Ÿä¸€å·¥å…·æ¥å£
```rust
// å†…ç½®å·¥å…·ã€MCPå·¥å…·ã€è‡ªå®šä¹‰å·¥å…·ä½¿ç”¨å®Œå…¨ç›¸åŒçš„API
trait Tool {
    fn name() -> &str;
    fn description() -> &str;
    async fn execute(args) -> Result<ToolResult>;
}

// å¯¹LLMé€æ˜
registry.execute_tool("any_tool_from_anywhere", args).await
```

### 4. æ™ºèƒ½ä¸Šä¸‹æ–‡ä¼˜åŒ–
```
ç­–ç•¥ï¼š
1. ä¿ç•™System Prompt
2. ä¿ç•™æœ€è¿‘Næ¡æ¶ˆæ¯
3. ä¿ç•™æ‰€æœ‰å·¥å…·è°ƒç”¨
4. æ€»ç»“æ—§æ¶ˆæ¯

â†’ é•¿å¯¹è¯ä¸ä¼šå¤±è´¥
```

### 5. Mockæµ‹è¯•æ¡†æ¶
```rust
// å®Œå…¨ä¸ä¾èµ–çœŸå®LLMçš„æµ‹è¯•
#[test]
async fn test_tool_auto_loop() {
    let mut mock_llm = MockLLMClient::new();
    mock_llm.add_response(/* é¢„è®¾å“åº” */);
    
    let updates = context.send_message_with_llm(msg, mock_llm).await;
    
    // éªŒè¯çŠ¶æ€è½¬æ¢åºåˆ—
    assert_eq!(updates[0].current_state, ProcessingMessage);
    assert_eq!(updates[1].current_state, ToolAutoLoop);
    assert_eq!(updates[2].current_state, Idle);
}
```

---

## âœ… æœ€ç»ˆç¡®è®¤

### è®¾è®¡å®Œæ•´æ€§
- âœ… æ‰€æœ‰æ ¸å¿ƒéœ€æ±‚å·²è¦†ç›–
- âœ… æ¶æ„åŸåˆ™æ¸…æ™°ä¸€è‡´
- âœ… å®è·µç»†èŠ‚å……åˆ†
- âœ… æŠ€æœ¯å¯è¡Œæ€§éªŒè¯

### è§„èŒƒç¬¦åˆæ€§
- âœ… OpenSpecä¸¥æ ¼éªŒè¯é€šè¿‡
- âœ… 32ä¸ªRequirements
- âœ… 136ä¸ªScenarios
- âœ… 10ä¸ªDecisions
- âœ… 167ä¸ªTasks

### å¯å®æ–½æ€§
- âœ… æ¸…æ™°çš„Phaseåˆ’åˆ†
- âœ… è¯¦ç»†çš„ä»£ç ç¤ºä¾‹
- âœ… å®Œæ•´çš„æµ‹è¯•ç­–ç•¥
- âœ… æ•°æ®è¿ç§»æ–¹æ¡ˆ

---

## ğŸ‰ ææ¡ˆå°±ç»ª

**è¿™ä¸ªææ¡ˆå·²ç»å®Œå…¨å°±ç»ªï¼Œå¯ä»¥å¼€å§‹å®æ–½ï¼**

æ‰€æœ‰æ ¸å¿ƒè®¾è®¡é—®é¢˜éƒ½å·²è§£å†³ï¼š
1. âœ… Context Manageræ˜¯çœŸæ­£çš„æ ¸å¿ƒ
2. âœ… çŠ¶æ€é©±åŠ¨æ•´ä¸ªç³»ç»Ÿ
3. âœ… åç«¯ç»Ÿä¸€ç®¡ç†ï¼ˆSessionã€Contextã€Toolï¼‰
4. âœ… å‰ç«¯åªè´Ÿè´£å±•ç¤ºå’Œäº¤äº’
5. âœ… å·¥å…·å¯¹ç”¨æˆ·é€æ˜
6. âœ… ä¸»åŠ¨æ³¨å…¥ä¸Šä¸‹æ–‡
7. âœ… å¤šå®¢æˆ·ç«¯å‹å¥½
8. âœ… MCPå®Œæ•´æ”¯æŒ
9. âœ… å¯æµ‹è¯•æ¶æ„

**å‡†å¤‡å¼€å§‹å®æ–½æ—¶ï¼Œè¯·å®¡æ‰¹è¿™ä¸ªææ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§ tasks.md çš„é¡ºåºé€æ­¥æ¨è¿›ï¼** ğŸš€

