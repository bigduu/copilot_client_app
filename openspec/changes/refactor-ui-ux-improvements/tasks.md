# UI/UX 改进与重构 - 实施任务清单

## Phase 1: 基础 UI 清理与优化

### 1.1 移除 Backend Contexts 面板

- [x] 1.1.1 从 `ChatSidebar/index.tsx` 中删除 Backend Contexts 相关代码
- [x] 1.1.2 移除相关的状态管理(backendContexts, isLoading, error)
- [x] 1.1.3 删除 `useBackendContext` hook 的调用(如果不再使用)
- [x] 1.1.4 更新样式,确保移除后布局正常
- [x] 1.1.5 测试验证:侧边栏显示正常,无遗留元素

### 1.2 实现 Chat 记忆功能

- [x] 1.2.1 在后端实现用户偏好设置 API (`PUT/GET /api/user/preferences`)
- [x] 1.2.2 创建 `UserPreferenceService` 前端服务类
- [x] 1.2.3 修改 `selectChat` action,异步保存选中的 Chat ID 到后端
- [x] 1.2.4 修改 `loadChats` action,从后端恢复上次打开的 Chat
- [x] 1.2.5 添加兜底逻辑:如果后端请求失败或 Chat 不存在,选择第一个可用 Chat
- [x] 1.2.6 确保操作异步且不阻塞 UI
- [ ] 1.2.7 测试验证:关闭并重新打开应用,上次的 Chat 被正确恢复
- [ ] 1.2.8 测试验证:在不同设备/客户端打开,记忆同步正确

### 1.3 优化 System Prompt 预览

- [x] 1.3.1 在 `SystemPromptSelector/index.tsx` 中优化 Markdown 渲染
- [x] 1.3.2 添加 `react-syntax-highlighter` 支持代码高亮
- [x] 1.3.3 改进预览卡片的样式,增加可读性
- [x] 1.3.4 添加"复制 Prompt"按钮
- [x] 1.3.5 优化长 Prompt 的显示(折叠/展开)
- [ ] 1.3.6 测试验证:预览效果良好,代码高亮正常工作

## Phase 2: 消息展示优化

### 2.1 创建结果展示组件

- [x] 2.1.1 创建共享的 utility 函数 `utils/resultFormatters.ts`
  - [x] JSON 检测和格式化函数
  - [x] 语法高亮处理
  - [x] 大型内容折叠逻辑
- [x] 2.1.2 创建 `components/ToolResultCard/index.tsx`
  - [x] 实现基础布局和样式
  - [x] 添加"AI Tool"标签和机器人图标(🤖)
  - [x] 不显示重试按钮
  - [x] 使用共享 utility 函数处理内容
- [x] 2.1.3 创建 `components/WorkflowResultCard/index.tsx`
  - [x] 实现基础布局和样式
  - [x] 添加"User Workflow"标签和齿轮图标(⚙️)
  - [x] 显示用户输入的参数
  - [x] 添加重试按钮和回调
  - [x] 使用共享 utility 函数处理内容
- [x] 2.1.4 集成 `react-json-view` 或类似库用于 JSON 展示
- [x] 2.1.5 添加"复制结果"按钮(两个组件都有)
- [x] 2.1.6 测试验证:两个组件独立工作,样式和功能正确

### 2.2 集成结果卡片到消息流

- [x] 2.2.1 在 `MessageCard/index.tsx` 中导入两个结果卡片组件
- [x] 2.2.2 检测消息类型为 `tool_result` 时使用 `ToolResultCard`
- [x] 2.2.3 检测消息类型为 `workflow_result` 时使用 `WorkflowResultCard`
- [x] 2.2.4 传递正确的 props(名称、参数、状态等)
- [x] 2.2.5 处理换行符和特殊字符,确保正确显示
- [x] 2.2.6 添加 loading 和 error 状态的处理
- [x] 2.2.7 测试验证:Tool 和 Workflow 结果在聊天中正确显示且明显区分

### 2.3 优化其他消息类型的展示

- [x] 2.3.1 检查并优化 Plan/Question 消息的显示
- [x] 2.3.2 确保所有消息类型的样式一致性
- [x] 2.3.3 添加消息的时间戳显示(可选)
- [ ] 2.3.4 测试验证:各种消息类型显示正常,样式一致

## Phase 3: 输入增强功能

### 3.1 扩展文件拖放和粘贴支持

- [x] 3.1.1 扩展 `utils/fileUtils.ts`,添加文件类型检测和内容提取函数
- [x] 3.1.2 修改 `useDragAndDrop.ts`,支持多种文件类型(不仅是图片)
- [x] 3.1.3 修改 `usePasteHandler.ts`,支持粘贴文件(通过 DataTransfer)
- [x] 3.1.4 添加文件大小和类型限制配置
- [x] 3.1.5 实现文本文件内容读取(使用 FileReader API)
- [x] 3.1.6 创建 `FilePreview` 组件,显示文件信息和内容预览
- [x] 3.1.7 在 `InputContainer` 中集成文件预览
- [ ] 3.1.8 测试验证:可以拖放/粘贴文本、代码文件,内容正确读取

### 3.2 实现 Workflow 命令高亮

- [x] 3.2.1 创建 `utils/inputHighlight.ts`,包含 Workflow 命令识别和高亮逻辑
- [x] 3.2.2 在 `MessageInput` 中添加 overlay div 用于显示高亮
- [x] 3.2.3 实现滚动同步和光标位置计算
- [x] 3.2.4 使用正则表达式识别 `/workflowName` 格式(不包括后面的参数)
- [x] 3.2.5 只对 Workflow 名称部分应用高亮样式,参数部分保持普通样式
- [x] 3.2.6 添加防抖,避免频繁计算影响性能
- [x] 3.2.7 确保与 WorkflowSelector 的触发逻辑协同工作
- [x] 3.2.8 测试验证:Workflow 名称正确高亮,参数不高亮,不影响输入

### 3.3 实现 @ 文件引用功能

- [x] 3.3.1 创建 `components/FileReferenceSelector/index.tsx`
- [x] 3.3.2 实现文件列表获取(Tauri API 或后端 API)
- [x] 3.3.3 添加搜索和过滤功能
- [x] 3.3.4 实现键盘导航(↑↓ 选择, Enter 确认, Esc 取消)
- [x] 3.3.5 在 `InputContainer` 中集成文件引用选择器
- [x] 3.3.6 监听 `@` 字符输入,触发选择器显示
- [x] 3.3.7 实现文件路径插入到输入框
- [x] 3.3.8 测试验证:@ 触发选择器,可以选择并插入文件引用

## Phase 4: AI 标题生成

### 4.1 实现后端 API

- [x] 4.1.1 在后端添加 `/api/contexts/{id}/generate-title` 端点
- [x] 4.1.2 实现标题生成逻辑(调用 LLM,根据对话内容生成)
- [x] 4.1.3 添加标题长度限制和格式校验
- [x] 4.1.4 添加错误处理和日志记录
- [x] 4.1.5 测试验证:API 可以正确生成标题

### 4.2 前端调用和集成

- [x] 4.2.1 在 `services/BackendContextService.ts` 中添加 `generateTitle` 方法
- [x] 4.2.2 在 `useChatManager.ts` 中添加标题生成逻辑
- [x] 4.2.3 在发送消息后,检测是否需要生成标题(消息数 <= 3)
- [x] 4.2.4 调用后端 API 生成标题
- [x] 4.2.5 更新 Chat 的 title 字段
- [x] 4.2.6 添加 loading 状态和错误处理
- [x] 4.2.7 在 `ChatItem` 中添加"重新生成标题"按钮
- [x] 4.2.8 测试验证:发送消息后,标题自动生成并更新

### 4.3 用户体验优化

- [x] 4.3.1 添加标题生成中的加载指示器
- [x] 4.3.2 如果生成失败,保留默认标题并提示用户
- [x] 4.3.3 添加用户偏好设置:是否启用自动标题生成
- [ ] 4.3.4 测试验证:标题生成流程流畅,用户体验良好

## Phase 5: 架构重构与性能优化

### 5.1 组件职责重新划分

- [x] 5.1.1 审查所有组件,识别职责不清晰的部分
- [x] 5.1.2 将通用逻辑提取为 hooks 或 utils
- [x] 5.1.3 减少组件内部的 local state,提升到 store
- [x] 5.1.4 优化组件的 props 接口,减少不必要的传递
- [x] 5.1.4 优化组件的 props 接口,减少不必要的传递
- [x] 5.1.5 测试验证:重构后功能正常,代码更清晰

### 5.2 性能优化

- [x] 5.2.1 使用 `React.memo` 包装不需要频繁更新的组件
- [x] 5.2.2 使用 `useMemo` 和 `useCallback` 优化计算和回调
- [x] 5.2.3 检查并修复不必要的重渲染
- [x] 5.2.4 对长列表(如聊天消息)考虑虚拟滚动(如果性能问题明显)
- [x] 5.2.5 图片和文件预览使用懒加载
- [x] 5.2.6 使用 React DevTools Profiler 检测性能瓶颈
- [ ] 5.2.7 测试验证:应用响应速度提升,无明显卡顿

### 5.3 代码清理和文档更新

- [x] 5.3.1 删除未使用的代码和依赖
- [x] 5.3.2 统一代码风格,运行 linter 和 formatter
- [x] 5.3.3 添加必要的代码注释和文档
- [x] 5.3.4 更新 README 和用户文档,说明新功能
- [ ] 5.3.5 测试验证:代码整洁,文档完善

## 验证和测试

### 6.1 单元测试

- [x] 6.1.1 为新的 utils 函数编写单元测试
- [ ] 6.1.2 为新的 hooks 编写测试
- [ ] 6.1.3 确保测试覆盖率达到合理水平(>80%)

### 6.2 集成测试

- [ ] 6.2.1 测试完整的用户流程:创建 Chat → 发送消息 → 查看 Tool 结果
- [ ] 6.2.2 测试文件拖放和 @ 引用功能
- [ ] 6.2.3 测试 Chat 记忆和标题生成功能
- [ ] 6.2.4 测试在不同浏览器和设备上的兼容性

### 6.3 用户体验测试

- [ ] 6.3.1 邀请真实用户测试新功能
- [ ] 6.3.2 收集反馈,识别 UX 问题
- [ ] 6.3.3 根据反馈进行迭代优化

### 6.4 性能测试

- [ ] 6.4.1 测试大量消息的加载和渲染性能
- [ ] 6.4.2 测试文件拖放和预览的性能
- [ ] 6.4.3 确保应用在低端设备上也能流畅运行

## 部署和回滚

**部署说明**: 本次重构允许破坏现有数据,不需要数据迁移,简化部署流程。

### 7.1 部署准备

- [x] 7.1.1 更新版本号和 CHANGELOG
- [x] 7.1.2 通知用户可能需要清空本地数据或重新登录
- [x] 7.1.3 准备数据库清理脚本(如果需要)

### 7.2 直接部署

- [ ] 7.2.1 部署到测试环境
- [ ] 7.2.2 清空测试环境数据(如果需要)
- [ ] 7.2.3 内部功能测试,确认所有功能正常
- [ ] 7.2.4 部署到生产环境
- [ ] 7.2.5 监控错误日志,确保功能正常
- [ ] 7.2.6 如有功能问题,立即回滚代码

### 7.3 后续优化

- [ ] 7.3.1 根据用户反馈继续优化
- [ ] 7.3.2 添加更多文件类型支持(如 PDF, Office 文档)
- [ ] 7.3.3 考虑移动端的特殊优化
- [ ] 7.3.4 探索更高级的输入增强功能(如智能补全)
